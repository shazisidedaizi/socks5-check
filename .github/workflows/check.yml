name: Proxy Checker

concurrency:
  group: proxy-checker
  cancel-in-progress: true
  
on:
  workflow_dispatch:  # 手动触发

jobs:
  run-checker:
    runs-on: ubuntu-latest
    steps:
      # 拉取仓库代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 安装 Go
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      # 查看 Go 版本（可选，调试用）
      - name: Show Go version
        run: go version

      # 构建二进制（零依赖，无需 go mod tidy）
      - name: Build binary
        run: go build -o checker .

      # 运行程序 + 完整日志
      - name: Run checker
        id: run
        continue-on-error: true  # 即使失败也继续，方便报警
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          API_TOKEN: ${{ secrets.API_TOKEN }}
          NODES_URL: ${{ secrets.NODES_URL }}
        run: |
          echo "::group::Proxy Checker Output"
          ./checker
          echo "::endgroup::"

      # 失败时发送 Telegram 报警
      - name: Send failure alert
        if: steps.run.outcome == 'failure'
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.CHAT_ID }}" \
            -d text="Proxy Checker 运行失败！请查看 GitHub Actions 日志：https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
